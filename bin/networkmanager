#!/bin/sh
set -e
set -x

# Create all necessary directories we need at runtime
mkdir -p $SNAP_DATA/conf/system-connections
mkdir -p $SNAP_DATA/run

# Create DHCP lease directory
mkdir -p /run/NetworkManager/dhcp

# Copy config into place
#
# TODO: if/when snappy grows support for provisioning
# files into $SNAP_DATA, this code should be removed
# in favor of the new mechanism.
if [ ! -e $SNAP_DATA/NetworkManager.conf ]; then
    cp $SNAP/etc/NetworkManager/NetworkManager.conf $SNAP_DATA
fi

# A directory where users can place any additional configuration
# files for NetworkManager
mkdir -p $SNAP_DATA/conf.d

export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$SNAP/usr/lib/NetworkManager"

$SNAP/usr/sbin/NetworkManager \
    --config-dir=$SNAP_DATA/conf.d/ \
    --system-config-dir=/run/NetworkManager/system-connections \
    --config=$SNAP_DATA/NetworkManager.conf \
    --log-level=INFO \
    --no-daemon
