#!/bin/sh
set -e
set -x

# Create all necessary directories we need at runtime
mkdir -p $SNAP_DATA/conf/system-connections
mkdir -p $SNAP_DATA/run

# Create DHCP lease directory
mkdir -p /run/NetworkManager/dhcp

# Select which config we're going to use. We offer our users
# to provide their own configuration file in $SNAP_DATA but
# will fallback if no one exists to the default one we ship
# in $SNAP
NM_CONF="$SNAP/etc/NetworkManager/NetworkManager.conf"
if [ -e $SNAP_DATA/NetworkManager.conf ]; then
    NM_CONF="$SNAP_DATA/NetworkManager.conf"
fi

# If netplan is not configured to render by default to NetworkManager
# configuration files we disable management of any ethernet device
# as this will clash with any configuration netplan puts in place
# for networkd.
if [ ! -e "/etc/netplan/00-default-nm-renderer.conf" ] ; then
    if [ ! -e "$SNAP_DATA/conf.d/disable-ethernet.conf" ] ; then
        echo "[keyfile]" > $SNAP_DATA/conf.d/disable-ethernet.conf
        echo "unmanaged-devices+=interface-name:eth*,interface-name:enx*" >> $SNAP_DATA/conf.d/disable-ethernet.conf
    fi
fi

# A directory where users can place any additional configuration
# files for NetworkManager
mkdir -p $SNAP_DATA/conf.d

export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$SNAP/usr/lib/NetworkManager"

$SNAP/usr/sbin/NetworkManager \
    --config-dir=$SNAP_DATA/conf.d/ \
    --config=$NM_CONF \
    --log-level=INFO \
    --no-daemon
