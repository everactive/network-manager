#!/bin/sh
set -e
set -x

# Create all necessary directories we need at runtime
mkdir -p $SNAP_DATA/conf/system-connections
mkdir -p $SNAP_DATA/run

# Create DHCP lease directory
mkdir -p /run/NetworkManager/dhcp

# Select which config we're going to use. We offer our users
# to provide their own configuration file in $SNAP_DATA but
# will fallback if no one exists to the default one we ship
# in $SNAP
NM_CONF="$SNAP/etc/NetworkManager/NetworkManager.conf"
if [ -e $SNAP_DATA/NetworkManager.conf ]; then
    NM_CONF="$SNAP_DATA/NetworkManager.conf"
fi

# A directory where users can place any additional configuration
# files for NetworkManager
mkdir -p $SNAP_DATA/conf.d

export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$SNAP/usr/lib/NetworkManager"

$SNAP/usr/sbin/NetworkManager \
    --config-dir=$SNAP_DATA/conf.d/ \
    --config=$NM_CONF \
    --log-level=INFO \
    --no-daemon
