#!/bin/sh

set -e
set -x

# Copy in our dbus policy until snappy has support for this
cp $SNAP_APP_PATH/etc/dbus-1/system.d/org.freedesktop.ModemManager1.conf \
    /etc/dbus-1/system.d/$SNAP_APP.conf

# We need a specific udev rule in place in order to tag all
# devices we might be interested in with a property so we
# can iterate them on startup.
cp $SNAP_APP_PATH/conf/80-mm-candidate.rules /etc/udev/rules.d/
# Reload all device information so that our new rule gets applied
udevadm trigger

TRIPLET=

case $SNAP_ARCH in
    amd64)
        TRIPLET=x86_64-linux-gnu
        ;;
    *)
        echo "ERROR: Architecture $SNAP_ARCH isn't supported by this snap"
        exit 1
esac

# XXX hardcoded architecture
LD_LIBRARY_PATH="$SNAP_APP_PATH/usr/lib/$TRIPLET:$SNAP_APP_PATH/usr/lib/$TRIPLET/ModemManager" \
$SNAP_APP_PATH/usr/sbin/ModemManager \
    --log-level=DEBUG \
    "$@"

# Cleanup everything we copied into the system
rm /etc/udev/rules.d/80-mm-candidate.rules \
    /etc/udev/rules.d/77-mm-telit.rules
udevadm trigger
