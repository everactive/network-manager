#!/bin/sh

set -e
set -x

# Copy in our dbus policy until snappy has support for this
cp $SNAP_APP_PATH/conf/dnsmasq-dbus.conf \
    /etc/dbus-1/system.d/$SNAP_APP.conf

mkdir -p $SNAP_APP_DATA_PATH/etc/NetworkManager/dnsmasq.d
mkdir -p $SNAP_APP_DATA_PATH/var/run/NetworkManager
touch $SNAP_APP_DATA_PATH/var/run/NetworkManager/dnsmasq.conf
chmod 0644 $SNAP_APP_DATA_PATH/var/run/NetworkManager/dnsmasq.conf

TRIPLET=

case $SNAP_ARCH in
    amd64)
        TRIPLET=x86_64-linux-gnu
        ;;
    *)
        echo "ERROR: Architecture $SNAP_ARCH isn't supported by this snap"
        exit 1
esac


# XXX hardcoded architecture
LD_LIBRARY_PATH="$SNAP_APP_PATH/usr/lib/$TRIPLET:$SNAP_APP_PATH/lib/$TRIPLET" \
$SNAP_APP_PATH/usr/sbin/dnsmasq \
    --no-resolv \
    --keep-in-foreground \
    --no-hosts \
    --listen-address=127.0.1.1 \
    --cache-size=0 \
    --proxy-dnssec \
    --bind-interfaces \
    --enable-dbus=org.freedesktop.NetworkManager.dnsmasq \
    --conf-file=$SNAP_APP_DATA_PATH/var/run/NetworkManager/dnsmasq.conf \
    --conf-dir=$SNAP_APP_DATA_PATH/etc/NetworkManager/dnsmasq.d \
    "$@"
