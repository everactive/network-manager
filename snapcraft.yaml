name: network-manager
vendor: Lo√Øc Minier <loic.minier@ubuntu.com>, Tony Espy <tony.espy@canonical.com>, Simon Fels <simon.fels@canonical.com>
version: 0.3
type: framework
architecture:
 - amd64
services:
  networkmanager:
    description: Network manager
    start: bin/networkmanager
    security-template: unconfined
    bus-name: org.freedesktop.NetworkManager
  dnsmasq:
    description: Dnsmasq
    start: bin/dnsmasq
    security-template: unconfined
    bus-name: org.freedesktop.NetworkManager.dnsmasq
#  modemmanager:
#    description: Modem manager
#    start: bin/modemmanager
#    security-template: unconfined
#    bus-name: org.freedesktop.ModemManager
binaries:
  nmcli:
    exec: usr/bin/nmcli
    security-template: unconfined
  nm-online:
    exec: usr/bin/nm-online
    security-template: unconfined
  nmtui:
    exec: usr/bin/nmtui
    security-template: unconfined
  nmtui-connect:
    exec: usr/bin/nmtui-connect
    security-template: unconfined
  nmtui-hostname:
    exec: usr/bin/nmtui-hostname
    security-template: unconfined
  nmtui-edit:
    exec: usr/bin/nmtui-edit
    security-template: unconfined
  iw:
    exec: sbin/iw
    security-template: unconfined
  iwlist:
    exec: sbin/iwlist
    security-template: unconfined
  iwlist:
    exec: sbin/iwlist
    security-template: unconfined
  iwconfig:
    exec: sbin/iwconfig
    security-template: unconfined
  mmcli:
    exec: usr/bin/mmcli
    security-template: unconfined
summary: Network management based on NeworkManager and ModemManager
description: Network management of wired ethernet, WiFi and mobile data connection based on NetworkManager and ModemManager
icon: icon.svg

parts:
  common:
    plugin: copy
    files:
      bin/networkmanager: bin/networkmanager
      bin/modemmanager: bin/modemmanager
      bin/dnsmasq: bin/dnsmasq
      conf/NetworkManager.conf: etc/NetworkManager/NetworkManager.conf
      conf/dnsmasq-dbus.conf: conf/dnsmasq-dbus.conf

  networkmanager:
    plugin: x-custom

    # NOTE: The branch below is a unpacked debian source package
    # generated from lp:~phablet-team/network-manager/enable-snappy-15.04
    # which helps to improve turn around times during development.
    source: https://git.launchpad.net/~phablet-team/+git/nm-enable-snappy-15.04
    source-type: git
    source-branch: unstable

    # We're using the debian packaging infrastructure here to build
    # the binaries instead of doing every step manually here.
    custom-cmds:
      - debian/rules build
      - make DESTDIR=$SNAPCRAFT_PART_INSTALL_DIR install
      - mkdir -p $SNAPCRAFT_PART_INSTALL_DIR/etc/NetworkManager/dispatcher.d
      - install -m 755 debian/network-manager-dispatcher.script $SNAPCRAFT_PART_INSTALL_DIR/etc/NetworkManager/dispatcher.d/01ifupdown
      - mkdir -p $SNAPCRAFT_PART_INSTALL_DIR/usr/lib/NetworkManager
      - install -m 755 debian/ifblacklist_migrate.sh $SNAPCRAFT_PART_INSTALL_DIR/usr/lib/NetworkManager
      - mkdir -p $SNAPCRAFT_PART_INSTALL_DIR/etc/dnsmasq.d/network-manager
      - install -m 644 debian/network-manager.dnsmasq $SNAPCRAFT_PART_INSTALL_DIR/etc/dnsmasq.d/network-manager

    # We stage everything here we need for build and runtime
    stage-packages:
      - adduser
      - dbus-test-runner
      - dnsmasq-base
      - gobject-introspection
      - gtk-doc-tools
      - init-system-helpers
      - intltool
      - iputils-arping
      - isc-dhcp-client
      - libc6
      - libdbus-1-3
      - libdbus-1-dev
      - libdbus-glib-1-2
      - libdbus-glib-1-dev
      - libgcrypt11-dev
      - libgcrypt20
      - libgirepository1.0-dev
      - libglib2.0-0
      - libglib2.0-dev
      - libglib2.0-doc
      - libgnutls-deb0-28
      - libgnutls28-dev
      - libgudev-1.0-0
      - libgudev-1.0-dev
      - libiw-dev
      - libmbim-glib4
      - libmm-glib-dev
      - libndp-dev
      - libndp0
      - libnewt-dev
      - libnewt0.52
      - libnl-3-200
      - libnl-3-dev
      - libnl-genl-3-200
      - libnl-genl-3-dev
      - libnl-route-3-200
      - libnl-route-3-dev
      - libpam-systemd
      - libpolkit-agent-1-0
      - libpolkit-gobject-1-0
      - libpolkit-gobject-1-dev
      - libqmi-glib1
      - libreadline-dev
      - libreadline6
      - libsoup2.4-1
      - libsoup2.4-dev
      - libsystemd-dev
      - libsystemd0
      - libudev-dev
      - libuuid1
      - lsb-base
      - pkg-config
      - policykit-1
      - ppp-dev
      - python-dbus
      - python-gi
      - udev
      - uuid-dev
      - valac
      - wireless-tools

    # Don't stage the following things as we would get conflicts at
    # build time otherwise
    stage:
      - -etc/dbus-1/system.d/org.freedesktop.ModemManager1.conf
      - -usr/bin/mmcli
      - -usr/include/libmm-glib/
      - -usr/lib/*/libmm-glib.so*
      - -usr/lib/*/ModemManager/
      - -usr/sbin/ModemManager
      - -usr/share/icons/hicolor/22x22/apps/ModemManager.png

    # We don't want that anything from our staged packages ends
    # up in the resulting snap. We only need them to build
    # NetworkManager. All runtime dependencies are pulled in with
    # the rdepends part below. The only left items specified
    # here are the results of the network manager build.
    filesets:
      binaries:
        - usr/bin/nm-online
        - usr/bin/nmcli
        - usr/bin/nmtui
        - usr/bin/nmtui-connect
        - usr/bin/nmtui-hostname
        - usr/bin/nmtui-edit
        - usr/lib/*/NetworkManager
        - usr/lib/pppd/2.4.6/nm-pppd-plugin.so
        - usr/lib/NetworkManager
        - usr/sbin/NetworkManager
        - usr/lib/*/libnm-*
      configs:
        - etc/NetworkManager
        - etc/dbus-1/system.d/*
      rdepends:
        - lib64/*
        - lib/*/
        - usr/lib/*/
        - sbin/iwconfig
        - sbin/iwlist
        - sbin/dhclient-script
        - sbin/dhclient
        - bin/ip
        - etc/dbus-1/system.d/dnsmasq.conf
        - etc/iproute2/
        - usr/sbin/arpd
        - usr/sbin/dnsmasq
        - usr/bin/arping
        - usr/share/dnsmasq-base/
        - etc/dhcp/
    snap:
      - $binaries
      - $configs
      - $rdepends

  modemmanager:
    plugin: x-custom
    after:
      - networkmanager
    source: https://git.launchpad.net/~phablet-team/+git/modemmanager-snappy-vivid
    source-type: git
    custom-cmds:
      - debian/rules build
      - make DESTDIR=$SNAPCRAFT_PART_INSTALL_DIR install
    stage-packages:
      - automake
      - libtool
      - intltool
      - gtk-doc-tools
      - gnome-common
      - gobject-introspection
      - libgirepository1.0-dev
      - libglib2.0-dev
      - libgudev-1.0-dev
      - libqmi-glib-dev
      - libmbim-glib-dev
      - libglib2.0-doc
      - valac
    filesets:
      binaries:
        - usr/bin/mmcli
        - usr/sbin/ModemManager
        - usr/lib/*/ModemManager
        - usr/lib/*/libmm-glib.so*
    snap:
      - $binaries
