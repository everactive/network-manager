summary: Verify WiFi WoWLAN can be enabled in NetworkManager globally via a snap config option

restore: |
    rmmod mac80211_hwsim

execute: |
    # Get two connected wifi network interfaces wlan0 and wlan1 and
    # give the system soem time to settle
    modprobe mac80211_hwsim radios=2
    sleep 1

    # Enable WoWLAN globally for all new WiFi connections
    snap set network-manager wifi.wake-on-wlan=any

    # Get us an AP via the wifi-ap we can use to create a connection to
    snap install wifi-ap

    # AP needs a bit to appear and be visible for NetworkManager
    /snap/bin/network-manager.nmcli d wifi rescan
    while ! /snap/bin/network-manager.nmcli d wifi | grep Ubuntu ; do
        /snap/bin/network-manager.nmcli d wifi rescan
        sleep 1
    done

    # Connect to the AP and ensure the connection was established
    /snap/bin/network-manager.nmcli d wifi | grep Ubuntu
    /snap/bin/network-manager.nmcli d wifi connect Ubuntu
    /snap/bin/network-manager.nmcli d | grep 'wlan1.*connected'

    # Now that we're connected a new connection exists which we can look at
    # to verify that the WoWLAN key is correctly set.
    /snap/bin/network-manager.nmcli c show Ubuntu | grep '802-11-wireless.wake-on-wlan:.*default (1)'

    if [ "$SPREAD_SYSTEM" = "hw-ubuntu-core-16" ]; then
        if ! iw phy phy0 info | grep -q "WoWLAN support:" ; then
            echo "INFO: Hardware does not support WoWLAN so we're not testing application"
            echo "      of the configuration option on the hardware."
            exit 0
        fi
        iw phy phy0 wowlan show | grep "WoWLAN is enabled"
        iw phy phy0 wowlan show | grep "wake up on special any trigger"
    fi
