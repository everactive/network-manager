summary: Test connection to a secured WiFi AP

environment:
    WIFI_SSID: Ubuntu
    WIFI_PASSPHRASE: Test1234

execute: |
    snap install wifi-ap

    # Get two connected wifi network interfaces wlan0 and wlan1
    modprobe mac80211_hwsim radios=2

    # Setup the AP on wlan1
    wifi-ap.config set wifi.interface wlan1
    wifi-ap.config set wifi.ssid $WIFI_SSID
    wifi-ap.config set wifi.security wpa2
    wifi-ap.config set wifi.security-passphrase $WIFI_PASSPHRASE
    wifi-ap.config set disabled 0
    systemctl restart snap.wifi-ap.backend
    # AP needs a bit to appear and be visible for NetworkManager
    network-manager.nmcli d wifi rescan
    while ! network-manager.nmcli d wifi | grep Ubuntu ; do
        network-manager.nmcli d wifi rescan
        sleep 1
    done

    network-manager.nmcli d wifi | grep $WIFI_SSID

    # Connect to the AP and ensure the connection was established
    network-manager.nmcli d wifi connect $WIFI_SSID password $WIFI_PASSPHRASE
    network-manager.nmcli d | grep 'wlan1.*connected'
