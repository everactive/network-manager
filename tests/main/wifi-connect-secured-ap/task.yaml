summary: Test connection to a secured WiFi AP

environment:
    WIFI_SSID: Ubuntu
    WIFI_PASSPHRASE: Test1234

restore: |
    rmmod mac80211_hwsim

execute: |
    snap install wifi-ap

    # Get two connected wifi network interfaces wlan0 and wlan1
    modprobe mac80211_hwsim radios=2

    # Setup the AP on wlan1
    /snap/bin/wifi-ap.config set wifi.interface wlan1
    /snap/bin/wifi-ap.config set wifi.ssid $WIFI_SSID
    /snap/bin/wifi-ap.config set wifi.security wpa2
    /snap/bin/wifi-ap.config set wifi.security-passphrase $WIFI_PASSPHRASE
    /snap/bin/wifi-ap.config set disabled 0
    systemctl restart snap.wifi-ap.backend
    # AP needs a bit to appear and be visible for NetworkManager
    /snap/bin/network-manager.nmcli d wifi rescan
    while ! /snap/bin/network-manager.nmcli d wifi | grep Ubuntu ; do
        /snap/bin/network-manager.nmcli d wifi rescan
        sleep 1
    done

    /snap/bin/network-manager.nmcli d wifi | grep $WIFI_SSID

    # Connect to the AP and ensure the connection was established
    /snap/bin/network-manager.nmcli d wifi connect $WIFI_SSID password $WIFI_PASSPHRASE
    /snap/bin/network-manager.nmcli d | grep 'wlan0.*connected'
