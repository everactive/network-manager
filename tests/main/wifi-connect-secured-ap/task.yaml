summary: Test connection to a secured WiFi AP

environment:
    WIFI_SSID: Ubuntu
    WIFI_PASSPHRASE: Test1234
    MAX_ITERATIONS: 20

execute: |
    snap install wifi-ap
    # FIXME: until the wifi-ap utility is clever enough to retry
    # connecting with the service we need to add a short sleep here
    sleep 0.5

    # Setup the AP on wlan0
    /snap/bin/wifi-ap.config set wifi.interface=wlan0
    /snap/bin/wifi-ap.config set wifi.ssid=$WIFI_SSID
    /snap/bin/wifi-ap.config set wifi.security=wpa2
    /snap/bin/wifi-ap.config set wifi.security-passphrase=$WIFI_PASSPHRASE

    # AP needs a bit to appear and be visible for NetworkManager
    /snap/bin/network-manager.nmcli d wifi rescan
    i=0
    while [ $i -lt $MAX_ITERATIONS ] ; do
      if /snap/bin/network-manager.nmcli d wifi | grep Ubuntu ; then
          break
      fi
      sleep 1
      let i=i+1
    done
    test $i -lt $MAX_ITERATIONS

    /snap/bin/network-manager.nmcli d wifi | grep $WIFI_SSID

    # Connect to the AP and ensure the connection was established
    /snap/bin/network-manager.nmcli d wifi connect $WIFI_SSID password $WIFI_PASSPHRASE
    /snap/bin/network-manager.nmcli d | grep 'wlan1.*connected'
