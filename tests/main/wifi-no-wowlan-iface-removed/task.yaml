summary: |
    Verify that WiFi interface is removed after NM stops if WoWLAN is
    not supported, even if enabled by NM.

environment:
    WIFI_SSID: Ubuntu
    WIFI_PASSPHRASE: Test1234

execute: |
    . $TESTSLIB/utilities.sh

    # Enable WoWLAN globally for all new WiFi connections
    snap set network-manager wifi.wake-on-wlan=any
    wait_for_network_manager

    # Replace core wpa-supplicant with one from snap
    sudo systemctl stop wpa_supplicant.service
    # TODO Install from stable when wowlan change lands
    snap install --edge wpa-supplicant
    snap connect network-manager:wpa wpa-supplicant:service
    sudo systemctl restart snap.network-manager.networkmanager.service

    # mac80211_hwsim does not support wowlan, check that
    ! iw phy phy0 wowlan show

    # Get us an AP via the wifi-ap we can use to create a connection to
    create_ap Ubuntu

    # Connect to the AP and ensure the connection was established
    /snap/bin/network-manager.nmcli d wifi | grep Ubuntu
    /snap/bin/network-manager.nmcli d wifi connect Ubuntu password "$WIFI_PASSPHRASE"
    /snap/bin/network-manager.nmcli d | grep 'wlan1.*connected'
    ip address show wlan1 | grep -q inet

    # Now that we're connected a new connection exists which we can look at
    # to verify that the WoWLAN key is correctly set.
    /snap/bin/network-manager.nmcli c show Ubuntu | grep '802-11-wireless.wake-on-wlan:.*default (1)'

    # Stop NM, then check that the interface is not configured anymore
    sudo systemctl stop snap.network-manager.networkmanager.service

    ip address show wlan1 | grep -vq inet
    ip address show wlan1 | grep -q "state DOWN"
