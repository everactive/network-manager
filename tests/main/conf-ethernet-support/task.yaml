summary: Verify ethernet support can be enabled via configuration option

execute: |
    . $TESTSLIB/utilities.sh
    case "$SPREAD_REBOOT" in
        0)
            # In the default setup NetworkManager doesn't take over ethernet
            wait_for_network_manager

            /snap/bin/network-manager.nmcli d | grep 'eth0.*unmanaged'

            # By default ethernet is disabled
            test "`snap get network-manager ethernet.enable`" = "false"

            # Enable ethernet support requires us to reboot two times to get
            # things into a right state.
            snap set network-manager ethernet.enable=true
            test "`snap get network-manager ethernet.enable`" = "true"

            REBOOT
            ;;
        1)
            # Give NetworkManager a bit to come up after the reboot
            wait_for_network_manager

            # After the first boot we're in a situation where both NetworkManager
            # and networkd are active and taking over ethernet. This is because
            # the hook itself currently can't change the netplan configuration
            # and the netplan generator systemd job runs before the NetworkManager
            # service is started so the 00-default-nm-renderer.yaml file will be
            # only created afterwards.
            test -e /etc/netplan/00-default-nm-renderer.yaml
            networkctl | grep 'eth0.*routable'

            REBOOT
            ;;
        2)
            # NetworkManager now controls eth0 and networkd does not
            /snap/bin/network-manager.nmcli d | grep 'eth0.*connected'
            # ... and we're running with the netplan configuration
            /snap/bin/network-manager.nmcli d | grep 'netplan-eth0'
            networkctl status eth0 | grep 'State: n/a'
            ;;
        *)
            exit 1
            ;;
    esac
