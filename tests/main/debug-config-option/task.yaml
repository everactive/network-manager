summary: Test network-manager snap debug configuration

execute: |
    . "$TESTSLIB"/utilities.sh

    test "$(snap get network-manager debug.enable)" = "false"
    if journalctl --no-pager -u snap.network-manager.networkmanager.service | MATCH "<debug>"; then
        printf "ERROR: debug traces while debug.enable not set"
        exit 1
    fi

    snap set network-manager debug.enable=true
    test "$(snap get network-manager debug.enable)" = "true"
    # NM will create the file after being re-started by the hook, wait a bit
    repeat_until_done "test -e /var/snap/network-manager/current/.debug_enabled" 5
    sleep 2
    network-manager.nmcli g log | MATCH "^DEBUG"

    snap set network-manager debug.enable=false
    test "$(snap get network-manager debug.enable)" = "false"
    # NM will create the file after being re-started by the hook, wait a bit
    repeat_until_done "test ! -e /var/snap/network-manager/current/.debug_enabled" 5
    sleep 2
    network-manager.nmcli g log | MATCH "^INFO"
