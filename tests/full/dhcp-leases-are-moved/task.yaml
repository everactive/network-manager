summary: Verify that the DHCP leases are moved to the correct location

execute: |
    . $TESTSLIB/utilities.sh

    wait_for_network_manager

    # We should have a single lease for eth0 at this point but give
    # NetworkManager some time to do its job
    test -e /run/NetworkManager/dhcp
    test -e /var/snap/network-manager/current/state/dhcp
    n=0
    state_ok=0
    while [ $n -lt 10 ] ; do
        num_leases=`ls -1 /var/snap/network-manager/current/state/dhcp | wc -l`
        num_public_leases=`ls -1 /run/NetworkManager/dhcp | wc -l`
        if [ $num_leases -eq $num_public_leases ]; then
            state_ok=1
            break
        fi
        sleep 0.5
        let n=n+1
    done
    test $state_ok -eq 1

    # Create a new lease file and ensure it gets copied over
    test ! -e /run/NetworkManager/dhcp/temp.lease
    touch /var/snap/network-manager/current/state/dhcp/temp.lease
    sleep 2
    test -e /run/NetworkManager/dhcp/temp.lease
    # Ensure that the lease is also removed from /run again when it
    # gets removed from SNAP_DATA
    rm /var/snap/network-manager/current/state/dhcp/temp.lease
    sleep 2
    test ! -e /var/snap/network-manager/current/state/dhcp/temp.lease
